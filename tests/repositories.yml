---

- hosts: localhost

  vars:

    manala_apt_preferences_exclusive: true
    manala_apt_preferences:
      - git@debian_backports
      - foo@debian_backports
      - php@dotdeb:300
      - dotdeb:100
      - dotdeb:200
      - package:  foo
        pin:      bar
        priority: 100
        file:     foo_bar

    manala_apt_repositories_exclusive: true
    manala_apt_repositories:
      - debian_security
      - nginx
      - nginx
      - source: deb http://packages.elastic.co/elasticsearch/1.7/debian stable main
      - source: deb http://packages.elastic.co/elasticsearch/1.7/debian stable main
      - source: deb http://deb.bearstech.com/debian {{ ansible_distribution_release }}-bearstech main
        key: bearstech
      - source: deb http://apt.postgresql.org/pub/repos/apt/ {{ ansible_distribution_release }}-pgdg main
        key:
          url: http://pgp.mit.edu/pks/lookup?op=get&search=0x8C718D3B5072E1F5
          id:  5072E1F5
      - pattern: proxmox_enterprise
        state:   absent

  roles:
    - manala.apt

  post_tasks:

    # Asserts
    - assert:
        that:
          - "{{
            __manala_apt_preferences_repositories_results.results|map(attribute='ansible_facts.__item')|list|sort == [
              'debian_backports',
              'debian_backports',
              'dotdeb',
              'dotdeb',
              'dotdeb'
            ]
          }}"
          - "{{
            ((__manala_apt_repositories_results.results|last).ansible_facts.__item.values() if (__manala_apt_repositories_results.results|length) else [])|sort == [
              {
                'source': 'deb http://packages.elastic.co/elasticsearch/1.7/debian stable main'
              },
              {
                'source': 'deb http://security.debian.org/ ' ~ ansible_distribution_release ~ '/updates main'
              },
              {
                'key': {
                  'id': '5072E1F5',
                  'url': 'http://pgp.mit.edu/pks/lookup?op=get&search=0x8C718D3B5072E1F5'
                },
                'source': 'deb http://apt.postgresql.org/pub/repos/apt/ ' ~ ansible_distribution_release ~ '-pgdg main'
              },
              {
                'key': 'bearstech',
                'source': 'deb http://deb.bearstech.com/debian ' ~ ansible_distribution_release ~ '-bearstech main'
              },
              {
                'key': 'dotdeb',
                'source': 'deb http://packages.dotdeb.org ' ~ ansible_distribution_release ~ ' all'
              },
              {
                'key': 'nginx',
                'source': 'deb http://nginx.org/packages/debian/ ' ~ ansible_distribution_release ~ ' nginx'
              },
              {
                'pin': 'release a=' ~ ansible_distribution_release ~ '-backports',
                'source': 'deb http://httpredir.debian.org/debian ' ~ ansible_distribution_release ~ '-backports main'
              },
              {
                'pattern': 'proxmox_enterprise',
                'source': 'deb https://enterprise.proxmox.com/debian ' ~ ansible_distribution_release ~ ' pve-enterprise',
                'state': 'absent'
              }
            ]
          }}"

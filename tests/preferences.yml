---

- hosts: localhost

  vars:

    manala_apt_preferences_exclusive: true
    manala_apt_preferences:
      - git@debian_backports
      - foo@debian_backports
      - php@dotdeb:300
      - dotdeb:100
      - dotdeb:200
      - package:  foo
        pin:      bar
        priority: 100
        file:     foo_bar

  roles:
    - manala.apt

  post_tasks:

    # Asserts
    - assert:
        that:
          - "{{
            ((__manala_apt_preferences_results.results|last).ansible_facts.__item.values() if (__manala_apt_preferences_results.results|length) else [])|sort == [
              {
                'file': 'dotdeb',
                'package': '*',
                'pin': 'origin packages.dotdeb.org',
                'priority': 200
              },
              {
                'file': 'foo',
                'package': '*',
                'pin': 'release a=' ~ ansible_distribution_release ~ '-backports',
                'priority': 900
              },
              {
                'file': 'foo_bar',
                'package': 'foo',
                'pin': 'bar',
                'priority': 100
              },
              {
                'file': 'git',
                'package': 'git git-*',
                'pin': 'release a=' ~ ansible_distribution_release ~ '-backports',
                'priority': 900
              },
              {
                'file': 'php',
                'package': 'php-* php5-* php7.0-*',
                'pin': 'origin packages.dotdeb.org',
                'priority': 300
              }
            ]
          }}"
